name: Migrations & Supabase deploy

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-migrations:
    name: Test migrations locally
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y postgresql-client
      - name: Run migrations (test)
        run: |
          chmod +x ./scripts/test_migrations.sh
          ./scripts/test_migrations.sh

  deploy:
    name: Deploy migrations to Supabase
    runs-on: ubuntu-latest
    needs: test-migrations
    # Allow deploy on push to main OR manual workflow_dispatch
    if: >-
      (github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch')
    steps:
      - uses: actions/checkout@v4
      - name: Install Supabase CLI (download binary)
        run: |
          sudo apt-get update
          sudo apt-get install -y curl ca-certificates tar jq
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then ARCH="x64"; fi
          if [ "$ARCH" = "aarch64" ]; then ARCH="arm64"; fi
          OS=$(uname -s | tr '[:upper:]' '[:lower:]')
          FILE="supabase_${OS}_${ARCH}.tar.gz"
          URL="https://github.com/supabase/cli/releases/latest/download/${FILE}"
          echo "Attempting to download $URL"
          if ! curl -fsSL "$URL" -o /tmp/supabase.tar.gz; then
            echo "Failed to download $URL â€” listing latest release assets to help debugging"
            curl -fsSL "https://api.github.com/repos/supabase/cli/releases/latest" | jq -r '.assets[].browser_download_url'
            exit 1
          fi
          tar -xzf /tmp/supabase.tar.gz -C /tmp
          sudo mv /tmp/supabase /usr/local/bin/
          supabase --version
      - name: Ensure Supabase secrets are set
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          # Support either SUPABASE_PROJECT_REF or legacy SUPABASE_URL
          : "${SUPABASE_PROJECT_REF:=}"
          if [ -z "${SUPABASE_PROJECT_REF}" ] && [ -n "${SUPABASE_URL}" ]; then
            SUPABASE_PROJECT_REF="$SUPABASE_URL"
          fi

          if [ -z "${SUPABASE_PROJECT_REF:-}" ] || [ -z "${SUPABASE_SERVICE_ROLE_KEY:-}" ] || [ -z "${SUPABASE_ACCESS_TOKEN:-}" ]; then
            echo "Required SUPABASE secrets are missing. Add SUPABASE_PROJECT_REF (or SUPABASE_URL), SUPABASE_SERVICE_ROLE_KEY and SUPABASE_ACCESS_TOKEN to repository secrets."
            exit 1
          fi

          echo "Using project ref: ${SUPABASE_PROJECT_REF}"
      - name: Authenticate supabase CLI
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          # Login using the Access Token (no-op if already set)
          set -x
          supabase login --token "$SUPABASE_ACCESS_TOKEN" || true
          supabase --version
      - name: Push migrations to Supabase
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # Use project ref (fall back to SUPABASE_URL if necessary)
          : "${SUPABASE_PROJECT_REF:=}"
          if [ -z "${SUPABASE_PROJECT_REF}" ] && [ -n "${SUPABASE_URL}" ]; then
            SUPABASE_PROJECT_REF="$SUPABASE_URL"
          fi

          echo "Setting remote (best-effort) and pushing migrations to ${SUPABASE_PROJECT_REF}"
          supabase db remote set "$SUPABASE_PROJECT_REF" --password "$SUPABASE_SERVICE_ROLE_KEY" || true
          supabase db push --project-ref "$SUPABASE_PROJECT_REF" --service-role-key "$SUPABASE_SERVICE_ROLE_KEY"
