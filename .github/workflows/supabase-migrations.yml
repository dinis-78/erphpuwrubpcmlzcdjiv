name: Migrations & Supabase deploy

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-migrations:
    name: Test migrations locally
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y postgresql-client
      - name: Run migrations (test)
        run: |
          chmod +x ./scripts/test_migrations.sh
          ./scripts/test_migrations.sh

  deploy:
    name: Deploy migrations to Supabase
    runs-on: ubuntu-latest
    needs: test-migrations
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - name: Install Supabase CLI (download binary)
        run: |
          sudo apt-get update
          sudo apt-get install -y curl ca-certificates tar
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then ARCH="x64"; fi
          if [ "$ARCH" = "aarch64" ]; then ARCH="arm64"; fi
          OS=$(uname -s)
          FILE="supabase_${OS}_${ARCH}.tar.gz"
          URL="https://github.com/supabase/cli/releases/latest/download/${FILE}"
          echo "Downloading $URL"
          curl -fsSL "$URL" -o /tmp/supabase.tar.gz
          tar -xzf /tmp/supabase.tar.gz -C /tmp
          sudo mv /tmp/supabase /usr/local/bin/
          supabase --version
      - name: Ensure Supabase secrets are set
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          if [ -z "${SUPABASE_URL:-}" ] || [ -z "${SUPABASE_SERVICE_ROLE_KEY:-}" ] || [ -z "${SUPABASE_ACCESS_TOKEN:-}" ]; then
            echo "Required SUPABASE secrets are missing. Add SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY and SUPABASE_ACCESS_TOKEN to repository secrets."
            exit 1
          fi
      - name: Push migrations to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          # Set remote (best-effort) and push migrations. Requires repository secrets mentioned above.
          supabase db remote set $SUPABASE_URL --password $SUPABASE_SERVICE_ROLE_KEY || true
          supabase db push --project-ref $SUPABASE_URL --service-role-key $SUPABASE_SERVICE_ROLE_KEY
