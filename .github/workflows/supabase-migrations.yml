name: Migrations & Supabase deploy

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  test-migrations:
    name: Test migrations locally
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y postgresql-client
      - name: Run migrations (test)
        run: |
          chmod +x ./scripts/test_migrations.sh
          ./scripts/test_migrations.sh

  deploy:
    name: Deploy migrations to Supabase
    runs-on: ubuntu-latest
    needs: test-migrations
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - name: Install Supabase CLI (via npm)
        run: |
          sudo apt-get update
          sudo apt-get install -y curl ca-certificates
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
          npm install -g supabase
          supabase --version
      - name: Ensure Supabase secrets are set
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          if [ -z "${SUPABASE_URL:-}" ] || [ -z "${SUPABASE_SERVICE_ROLE_KEY:-}" ] || [ -z "${SUPABASE_ACCESS_TOKEN:-}" ]; then
            echo "Required SUPABASE secrets are missing. Add SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY and SUPABASE_ACCESS_TOKEN to repository secrets."
            exit 1
          fi
      - name: Push migrations to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          # Set remote (best-effort) and push migrations. Requires repository secrets mentioned above.
          supabase db remote set $SUPABASE_URL --password $SUPABASE_SERVICE_ROLE_KEY || true
          supabase db push --project-ref $SUPABASE_URL --service-role-key $SUPABASE_SERVICE_ROLE_KEY
